<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../deko-card-container/deko-card-container.html">
<link rel="import" href="../deko-card-editor/deko-card-editor.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../input-image/input-image.html">
<link rel="import" href="../deko-card/deko-card.html">
<link rel="import" href="shared-styles.html">

<!--
  `<deko-cards></deko-cards>` Cards with pagination
  @demo demo.html
-->
<dom-module id="deko-cards">
  <style is="custom-style" include="shared-styles">
    paper-button {
      color: #fff;
      background: red;
      padding: 5px;
    }
  </style>
  <template>
    <template is="dom-if" if="[[pageing]]" restamp>
      <paper-input label="Start At ..." value="{{find}}"></paper-input>
    </template>
    <div id="card-view">
      <deko-card-container>
        <template is="dom-if" if="[[!items.length]]">
          <paper-spinner-lite active></paper-spinner-lite>
        </template>
        <template is="dom-repeat" items="{{items}}" initial-Count="1">
          <deko-card edit toolbar-color="[[deckColor]]" card="[[item]]" icon="[[item.icon]]" on-tapped="cardTapped" on-edit="edit" on-open="open"></deko-card>
        </template>
      </deko-card-container>
    </div>
    <template is="dom-if" if="[[pagesLength]]">
      <paper-button raised on-tap="perv"> &lt; </paper-button>
    </template>
    <template is="dom-if" if="[[nextPageStartAt]]">
      <paper-button style="float:right" raised on-tap="next"> > </paper-button>
    </template>
    <deko-card-editor no-add="[[noAdd]]" use-templates="[[useTemplates]]" id="editor" card="{{editing}}" on-close="closeEditor" deck="[[deck]]"></deko-card-editor>
  </template>
</dom-module>
<script>
  Polymer({
    is: "deko-cards",
    properties:{
      _setItems:{
        computed:"setItems(path, byChild, loadNum, startAt)",
      },
      end:{value: 999},
      path:{type: String},
      find:{value: ""},
      deck:{value: ""},
      pages:{value: []},
      noAdd:{
        type:Boolean,
        value:false,
      },
      byChild:{type: String, value:'title'},
      loadNum:{type: Number, value: 10},
      startAt:{computed:"getStartAt(pages, find)"},
      pagesLength:{computed:"getPagesLength(pages)"},
      useTemplates: Object,
      pageing:{
        type:Boolean,
        value:false,
      },
    },
    cardTapped: function(e, d) {
      if (d.hasOwnProperty("target")) {
        if (d.target.attributes.id) {
          if (typeof this[d.target.id] === "function") {
            this[d.target.id](d)
          }
        }
      }
    },
    edit: function(e,d) {
      this.set("editing",d)
      this.$.editor.open(d)
    },
    save: function(e) {
      var saveRef = firebase.database().ref(this.path)
      if (e.hasOwnProperty("target")) {
        saveRef.child(e.target.card.__key).set(e.target.card)
      } else if (e.hasOwnProperty("__key")){
        saveRef.child(e.__key).set(e)
      } else if (this.editing.hasOwnProperty("__key")) {
        var key = this.editing.__key + ""
        delete(this.editing.__key)
        saveRef.child(key).set(this.editing)
      }
    },
    closeEditor: function(d) {
      var saveRef = firebase.database().ref(this.path)
      if (this.deck) {
        var saveCardsRef = firebase.database().ref('/Cards/')
      }
      if (d.detail === "save") {
        if (this.editing.hasOwnProperty("__key")) {
          var key = this.editing.__key + ""
          delete(this.editing.__key)
        } else {
          var key = firebase.database().ref().child('Cards').push().key
        }
        var save = Object.keys(this.editing).reduce(function(toSave, currentKey) {
          if (!toSave[currentKey]) {
            delete(toSave[currentKey])
          }
          return toSave
        },this.editing)
        if (this.deck) {
          save.deck = this.deck
          saveCardsRef.child(key).set(save)
        }
        saveRef.child(key).set(save)
      } else if (d.detail === "delete") {
        if (this.editing.hasOwnProperty("__key")) {
          var key = this.editing.__key + ""
          saveRef.child(key).set(null)
        }
        if (this.deck) {
          saveCardsRef.child(key).set(null)
        }
      }
      this.editing = null
    },
    getStartAt: function(pages, find){
      if (find) {
        return find
      } else if (pages.length) {
        return pages[pages.length - 1].start
      } else {
        return ""
      }
    },
    perv: function(){
      this.pages.pop()
      if (this.pages.length) {
        this.find = this.pages[this.pages.length - 1].start
      } else {
        this.find = ""
      }
      this.pages = this.pages.map(function(x) {return x}) // update
      return 1
    },
    next: function(){
      var start = this.nextPageStartAt
      this.find = start
      // var end = this.end
      if ((this.pages.length === 0 || start !== this.pages[this.pages.length-1].start)) { // && this.pages.length < end) {
        this.pages.push({
          start: start,
        })
        this.pages = this.pages.map(function(x) {return x}) // update 
        
        return 1
      }
      return 0
    },
    getPagesLength: function(pages){
      return pages.length
    },
    setItems: function(path, byChild, loadNum, startAt){
      var that = this
      
      function objectToArray(data) {
        var output = []
        if (data) {
          var keys = Object.keys(data)
          for (var i = 0; i < keys.length; i++) {
            if (typeof data[keys[i]] === 'object') {
              data[keys[i]].__key = keys[i]
              output.push(data[keys[i]])
            }
          }
        }
        return output
      }
      function sortByChild (a,b){
        if (a.hasOwnProperty(byChild) && b.hasOwnProperty(byChild)) {
          var A = a[byChild].toUpperCase()
          var B = b[byChild].toUpperCase()       
          if (A < B) { return -1 }
          if (A > B) { return 1 }
        }
        return 0
      }
      var setItems = function(snap) {
        var theSnap = snap.val()
        if (theSnap) {
          that.loaded = Object.keys(theSnap).length 
          that.items = objectToArray(theSnap).sort(sortByChild)
          if (that.loaded == +loadNum) {
            if (that.items[+loadNum - 1][byChild]) {
              that.nextPageStartAt = that.items[+loadNum - 1][byChild] + "~"
            } else {
              that.nextPageStartAt = "A"
            }
          } else {
            that.nextPageStartAt = null
            that.end = 1+that.pagesLength
          }
        } else {
          that.nextPageStartAt = null
          that.end = 1+that.pagesLength
        }
      }
      var listRef
      if (byChild === "__key"){
        listRef = firebase.database().ref(path).orderByKey()
      } else {
        listRef = firebase.database().ref(path).orderByChild(byChild)
      }
      if (startAt) {
  //      if (startAt === "true") {
  //        listRef.equalTo(true).limitToFirst(+loadNum).on("value", setItems)
  //      } else if (startAt === "null"){
  //        listRef.equalTo(null).limitToFirst(+loadNum).on("value", setItems)
  //      } else {
          listRef.startAt(startAt).limitToFirst(+loadNum).on("value", setItems)
  //      }
      } else {
        listRef.limitToFirst(+loadNum).on("value", setItems)
      }
    },
    open: function(e,d){
      this.fire("open-card",{e:e,d:d})
    }
  })
</script>
