<link rel="import" href="../input-image/input-image.html">
<!--
  `<deko-cards></deko-cards>` Cards with pagination
  @demo demo.html
-->
<dom-module id="deko-cards">
  <template>
    [[startAt]]
    <template is="dom-repeat" items="{{items}}" initial-Count="1">
      <deko-card item="[ [ item ] ]">
        <paper-material>
          <a href="[[item.link]]">link</a>
          <h1>[[item.title]]</h1>
          <template is="dom-if" if="[[item.cardIcon]]">
            auto <input-image big="[[item.cardIcon]]" value="{{item._image}}"></input-image>
          </template>
          <template is="dom-if" if="![[item.cardIcon]]">
            <input-image value="{{item.image}}"></input-image>
          </template>
          <button data-index="[[index]]" on-tap="edit"> edit </button>
        </paper-material>
      </deko-card>
    </template>
    <template is="dom-if" if="[[pagesLength]]">
      <button on-tap="perv"> &lt; </button>
    </template>
    <button on-tap="save"> save </button>
    <template is="dom-if" if="[[nextPageStartAt]]">
      <button on-tap="next"> > </button>
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "deko-cards",
    properties:{
      _setItems:{
        computed:"setItems(path, byChild, loadNum, startAt)",
      },
      end:{value: 999},
      path:{type: String},
      pages:{value: []},
      byChild:{type: String, value:'title'},
      loadNum:{value: 100},
      startAt:{computed:"getStartAt(pages)"},
      pagesLength:{computed:"getPagesLength(pages)"},
    },
    save: function(e) {
      var saveRef = firebase.database().ref(this.path)
      
      function logArrayElements(element, index) {
        if (element._image && element.cardIcon) {
          var toSave = {}
          if (element._image) {
            toSave.image = element._image.trim()
          }
          if (element.desc) {
            toSave.desc = element.desc.trim()
          }
          if (element.title) {
            toSave.title = element.title.trim()
          } else {
            if (element.link) {
              toSave.title = element.link.trim()
            } else {
              toSave.title = "~ No Title or Link"
            }
          }
          if (element.link) {
            toSave.link = element.link.trim()
          }
          this.child(element.__key).set(toSave)
        }
        console.log('a[' + index + '] = ' + element)
      }
      if (Array.isArray(this.items)) {
        this.items.forEach(logArrayElements, saveRef)
      }
    },
    getStartAt: function(pages){
      if (pages.length) {
        return pages[pages.length - 1].start
      } else {
        return ""
      }
    },
    perv: function(){
      this.pages.pop()
      this.pages = this.pages.map(function(x) {return x}) // update 
      return 1
    },
    next: function(){
      this.save()
      var start = this.nextPageStartAt
      var end = this.end
      if ((this.pages.length === 0 || start !== this.pages[this.pages.length-1].start) && this.pages.length < end) {
        this.pages.push({
          start: start,
        })
        this.pages = this.pages.map(function(x) {return x}) // update 
        return 1
      }
      return 0
    },
    getPagesLength: function(pages){
      return pages.length
    },
    setItems: function(path, byChild, loadNum, startAt){
      var that = this
      
      function objectToArray(data) {
        var output = []
        if (data) {
          var keys = Object.keys(data)
          for (var i = 0; i < keys.length; i++) {
            if (typeof data[keys[i]] === 'object') {
              data[keys[i]].__key = keys[i]
              output.push(data[keys[i]])
            }
          }
        }
        return output
      }
      function sortByChild (a,b){
        if (a.hasOwnProperty(byChild) && b.hasOwnProperty(byChild)) {
          var A = a[byChild].toUpperCase()
          var B = b[byChild].toUpperCase()       
          if (A < B) { return -1 }
          if (A > B) { return 1 }
        }
        return 0
      }
      var setItems = function(snap) {
        var theSnap = snap.val()
        if (theSnap) {
          that.loaded = Object.keys(theSnap).length 
          that.items = objectToArray(theSnap).sort(sortByChild)
          if (that.loaded == loadNum) {
            if (that.items[loadNum - 1][byChild]) {
              that.nextPageStartAt = that.items[loadNum - 1][byChild] + "~"
            } else {
              that.nextPageStartAt = "A"
            }
          } else {
            that.nextPageStartAt = null
            that.end = 1+that.pagesLength
          }
        } else {
          console.log('no data')
          that.nextPageStartAt = null
          that.end = 1+that.pagesLength
        }
      }
      var listRef = firebase.database().ref(path).orderByChild(byChild)
      if (startAt) {
        listRef.startAt(startAt).limitToFirst(loadNum).on("value", setItems)
      } else {
        listRef.limitToFirst(loadNum).on("value", setItems)
      }
    },
  })
</script>
