<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../deko-opened-card/deko-opened-card.html">
<link rel="import" href="../deko-card-container/deko-card-container.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../input-image/input-image.html">
<link rel="import" href="../image-base64/image-base64.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../deko-card/deko-card.html">
<link rel="import" href="../open-card/open-card.html">
<link rel="import" href="../quill-js/quill-js.html">
<!--
  `deko-cards`
  @demo
-->
<dom-module id="deko-cards">
  <template>
    <style>
      #narrow {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        height: 100%;
      }
      paper-button {
        color: #fff;
        padding: 5px;
      }
      #card-view {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        @apply(--layout-wrap);
      }
      deko-card-container {
        margin-top: 50px;
      }
      .pre.desktop {
        left: 80px;
      }
      .nex.desktop {
        right: 80px;
      }
      .desktop {
        position: absolute;
        top: 320px;
      }
      .nex.mobile {
        position: absolute;
        left: 200px;
        bottom: -45px;
      }
      .pre.mobile {
        position: absolute;
        left: 200px;
        bottom: -25px;
      }
      .mobile {
        transform: rotate(90deg);   
      }
      paper-button {
        min-width: 2em;
        min-height: 8em;
        background: none;
        color: #ff5722;
      }
      h6 {
        -webkit-transform:scale(3,15); /* Safari and Chrome */
        -moz-transform:scale(3,15); /* Firefox */
        -ms-transform:scale(3,15); /* IE 9 */
        -o-transform:scale(3,15); /* Opera */
        transform:scale(3,15); /* W3C */
      }
      paper-toolbar {
        --paper-toolbar-height: 35px;
        --paper-toolbar-sm-height: 35px;
        --paper-toolbar-title: {
          font-size: 18px;
          font-weight: 300;
        }
      }
      .toolbarMobile {
         box-shadow: 0 -2px 0px 0 rgba(0, 0, 0, 0.14),
                     0 -1px 0px 0 rgba(0, 0, 0, 0.12),
                     0 -3px 1px -2px rgba(0, 0, 0, 0.2);
         margin-left: 2px;
      }
    </style>
    <app-route route="{{route}}" pattern="/:data" data="{{routeData}}" tail="{{tail}}"></app-route>
    <iron-media-query query="(min-width: 700px)" query-matches="{{wide}}"></iron-media-query>
    <!--Wide Layout for Desktop-->
    <template is="dom-if" if="{{wide}}">
      <template is="dom-if" if="[[pageing]]" restamp>
        <paper-input label="Start At ..." value="{{find}}"></paper-input>
      </template>
      <div id="card-view">
        <div class="pre desktop">
          <template is="dom-if" if="[[pagesLength]]">
            <paper-button on-tap="perv"><h6>&lt;</h6></paper-button>
          </template>
        </div>
        <deko-card-container>
          <template is="dom-repeat" items="{{items}}" initial-Count="1" id="list0">
            <deko-card ref="{{item.ref}}" on-tap="selectOpen" card="{{item}}" title="[[item.title]]"></deko-card>
          </template>
        </deko-card-container>
        <div class="nex desktop">
          <template is="dom-if" if="[[nextPageStartAt]]">
            <paper-button on-tap="next"><h6>></h6> </paper-button>
          </template>
        </div>
      </div>
      <template is="dom-if" if="[[!noAdd]]">
        <paper-fab style="position: fixed;right: 25px;bottom: 30px" icon="add" on-tap="addCard"></paper-fab>
      </template>
    </template>
    <!--Narrow Layout under 700px-->
    <template is="dom-if" if="{{!wide}}">
      <template is="dom-if" if="[[pageing]]" restamp>
        <paper-input label="Start At ..." value="{{find}}"></paper-input>
      </template>
      <div style="height: 100%">
        <div class="pre mobile">
          <template is="dom-if" if="[[pagesLength]]">
            <paper-button on-tap="perv"><h6>&lt;</h6></paper-button>
          </template>
        </div>
        <template is="dom-repeat" items="{{items}}" filter="pickable"  id="list1">
          <paper-toolbar class="toolbarMobile" on-tap="select" title="[[item.title]]" card="{{item}}" style$="background:[[deckColor]]; height: 35px;">
            <iron-icon icon="[[item.icon]]" style="height:90%"></iron-icon>
            <div class="title">[[item.title]]</div>
          </paper-toolbar>
        </template>
        <template is="dom-if" if="[[selectedItem]]">
          <div id="narrow">
            <deko-card ref="{{selectedItem.ref}}" on-tap="selectOpen" card="{{selectedItem}}"></deko-card>
          </div>
        </template>
        <div class="nex mobile">
          <template is="dom-if" if="[[nextPageStartAt]]">
            <paper-button on-tap="next"><h6>></h6> </paper-button>
          </template>
        </div>
      </div>
    </template>
    <open-card on-touchstart="noDrag" on-mousedown="noDrag" rem-loading="[[loading]]" selected="{{cardPart}}" heading="[[cardHeading]]" on-cancel="deleteCard" on-new="new">
      <quill-js theme='bubble' value="{{addingStuff}}" editor="{{quill}}"></quill-js>
      <deko-opened-card ref="{{selectedItem.ref}}"></deko-opened-card>
      <template is="dom-if" if="[[signedOff]]">
        <h3>signedOff</h3>
      </template>
    </open-card>
    <image-base64 url="[[addingBigImage]]" max-height="200" max-width="200" base64="{{addingImage}}"></image-base64>
  </template>
</dom-module>
<script>
  Polymer({
    is: "deko-cards",
    properties:{
      _setItems:{
        computed:"setItems(cards, byChild, loadNum, startAt, wide)",
      },
      end:{value: 999},
      find:{value: ""},
      deck:{value: ""},
      pages:{value: []},
      noAdd:{
        type:Boolean,
        value:false,
      },
      byChild:{type: String, value:'title'},
      loadNum:{type: Number, value: 10},
      startAt:{computed:"getStartAt(pages, find)"},
      pagesLength:{computed:"getPagesLength(pages)"},
      useTemplates: Object,
      pageing:{
        type:Boolean,
        value:false,
      },
      _setSelectedItem:{
        computed:"getSelectedItem(items)"
      },
      _routeData: {
        computed: "_log('routeData.data',routeData.data)"
      },
      cards: {
        computed: "getCards(ref)"
      },
      addingStuff: {
        observer: "testStuff"
      },
      cardPart: {
        observer: "changingPart"
      },
      addingName: {
        observer: "changingName"
      },
    },
    noDrag: function(e) {
      e.stopPropagation()
    }, 
    new: function() {
      
      this.set("loading", true)
      this.set("selectedItem", "")
      
      this.set("addingStuff", [{"insert":"\n"}])
      this.set("addingName", "")
      this.set("addingImage", "")
      this.set("addingBigImage", "")
      
      this.set("loading", false)
    },
    newCard: function(toAddQuill) {
      var that = this
      
      that.set("loading", true)      
      that.cards.add({title:that.addingName}).then(function(doc) {
        
        that.set("selectedItem", {})
        that.set("selectedItem.ref", doc)
        
        if (toAddQuill) {
          doc.collection("quill").add(toAddQuill).then().catch()
        }
        that.set("loading", false)
      }).catch(function(error) {
        console.error("Error adding card: ", error);
      })
    },
    changingName: function(name) {
      this.debounce("save", function () {
        if (this.selectedItem && this.selectedItem.ref) {
          this.selectedItem.ref.set({title:name})
        }
      }, 2000)
    },
    deleteCard: function() {
      var that = this
      if (that.selectedItem && that.selectedItem.ref) {
        that.selectedItem.ref.delete().then(function() {

          that.set("addingStuff", [{"insert":"\n"}])
          that.set("addingName", "")
          that.set("addingImage", "")
          that.set("addingBigImage", "")
          
          that.set("selectedItem", null)
          
          that.set("loading", false)
        }).catch(function(error) {
          console.error("Error removing card: ", error);
        })
      }
    },
    testStuff: function(stuff){
      var name
      var head
      var headAt
      var add
      var addAt
      var getRandom = function (min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min)) + min;
      }
      var tricks = {
        image:{
          intent: "^(add|with) image",
          ask: "for url",
          action:[
            {insert: "\n",},
            {insert: {image: `{{url}}`,}},
            {insert: "\n",},
          ],
        },
        list:{
          intent: "^(?:add|in a) list (.+)",
          action: [
            {insert: "\n"},
            { 
              attributes: {
                list: "bullet"
              },
              insert: "$1\n",
            },
          ],
          split: "\\s?,\\s?",
        },
        heading: {
          intent: "^(?:add|in a) (?:heading|title) (.+)$",
          action: [
            {insert: "\n"},
            { 
              attributes: {
                header: 2
              },
              insert: "$1\n",
            },
          ],
        },
        signedOff:{
          intent:"^(?:add|with)  Signed(?:[ -])?off(?: by )([\w]*)*$",
          search: `$1`,
        },
        dek:{
          intent:"^add (?:this )?to (new)? de[ck]+$",
          subst: `\n>>In a deck<<\n`,
        },
        files: {
          intent: "^add (file|document)$",
          ask: ["for files"],
          subst: `\n>>files<<\n`,
        },
        reminder: {
          intent: "^add reminder$",
          ask: ["for date/time"],
          subst: `\n>>reminding<<\n`,
        },
        give: {
          intent: "^give( )?$",
          subst: `\n>>giving<<\n`,
        },
        show: {
          intent: "^show( )?$",
          subst: `\n>>showing<<\n`,
        },
        timer: {
          intent: "^(add|make) timer (?:for )?([\d]+) min(?:utes)?$",
          minutes: `$1`,
        },
      }
      var titleImage
      for (var op in stuff) {
        if (stuff[op].insert && typeof stuff[op].insert  === 'string') {
          if (!name) { 
            name = stuff[op].insert.split("\n")[0]
            if (name) {
              if (!stuff[op].attributes) {
                var notName = stuff[op].insert.split("\n").splice(1).join("\n")
                if (notName.replace(/[^0-9a-z-A-Z ]/g, "").trim()) {
                  head = [
                    {insert: name},
                    {insert: "\n", attributes: {header:1}},
                    {insert: notName},
                  ]
                  headAt = op
                }
              }
              this.addingName = name.replace(/[^0-9a-z-A-Z ]/g, "").trim()
            } else if (stuff[op].insert.split("\n").join("") || !this.addingName) {
              this.addingName = stuff[op].insert.split("\n").join("")
            }
          }
          if (!add) {
            var lines = stuff[op].insert.split("\n")
            for (var line in lines) {
              var toAdd = lines[line]
              if (toAdd) {
                for (var trick in tricks) {
                  var regex = new RegExp(tricks[trick].intent, "i")
                  while ((matchs = regex.exec(toAdd)) !== null && !add) {
                    if (matchs.index === regex.lastIndex) {
                      regex.lastIndex++
                    }
                    matchs.forEach((match, groupIndex) => {
                      console.log(`Found match, group ${groupIndex}: ${match}`)
                    })
                    var addBefore = lines.splice(0, +line   ).join("\n")
                    addAt = op
                    var addAfter  = lines.splice(1 + +(line)).join("\n")
                  
                    if (tricks[trick].action) {
                      var action
                      
                      if (!tricks[trick].split) {
                        action = JSON.parse(
                          toAdd.replace(regex, JSON.stringify(tricks[trick].action)).replace(/(\n|\t)/gm,"\\n")
                        )
                      } else {
                        action = JSON.parse(
                          toAdd.replace(new RegExp(tricks[trick].split, "gm"), "\\n").replace(regex, JSON.stringify(tricks[trick].action)).replace(/(\n|\t)/gm,"\\n")
                        )
                      }
                      
                      add = [{insert: addBefore + "\n"}].concat(action, [{insert: addAfter + "\n"}])
                      
                    } else {
                      add = [
                        {insert: addBefore + "\n"},
                        {insert: addAfter + "\n"},
                      ]
                    }
                    
                  }
                }
              }
            }
          }
        }
        if (stuff[op].insert && stuff[op].insert.image) {
          if (stuff[op].insert.image.length > 1000*1000) {
            this.resizeImage(stuff, op)
          }
          if (!titleImage) {
            titleImage = "done"
            this.addingBigImage = stuff[op].insert.image
          }
        }
      }
      if (head) {
        stuff = stuff.splice(0, +headAt).concat(head, stuff.splice(1 + +(headAt)))
      } 
      if (add) {
        stuff = stuff.splice(0, +addAt ).concat(add,  stuff.splice(1 + +(addAt) ))
      }
      if (add || head) {
        this.set("addingStuff", stuff)
      }
    },
    resizeImage: function(stuff, opForImage) {
      var that = this
      loadImage(
        stuff[opForImage].insert.image,
        function (canvas) {
          if (canvas.toDataURL) {
            stuff[opForImage].insert.image = canvas.toDataURL()
            that.set("addingStuff", stuff.map(function(x) {return x}) )
          }
        }, {
          canvas: true,
          maxHeight: 500,
          maxWidth: 500,
          orientation: true,
        }
      )
    },
    getCards: function(dek) {
      return dek.collection("cards")
    },
    changingPart: function(part, partFrom) {
      var that = this
      var ref 
      if (that.selectedItem) {
        ref = that.selectedItem.ref
      }
      if (part == 0) {
        this.cardHeading = "Let's get started" 
      }
      if (part == 0 && partFrom == 1){
        if (ref) {
          that.set("loading", true)
          ref.collection("quill").orderBy("time", "desc").limit(1).get().then(function(data) {
            that.set("loading", false)
            if (data && data.size) {
              var value = data.docs[0].data().value
              if (JSON.stringify(that.addingStuff) !== JSON.stringify(value)) {
                that.set("addingStuff", value)
              }
              that.set("cardHeading", "Change Card") 
            } else {
              that.set("addingStuff", [{"insert":"\n"}])
              that.set("cardHeading", "Let's add some text") 
            }
          })
        }
      }
      if (part == 1 && partFrom == 0 && JSON.stringify(this.addingStuff) != JSON.stringify([{"insert":"\n"}])){
        var quill = {
          value: that.addingStuff,
          time:  Date.now(), // firebase.database.ServerValue.TIMESTAMP,
          user:  firebase.auth().currentUser.uid,
        }
        if (ref) {
          that.set("loading", true)
          ref.collection("quill").add(quill).then(function(data) {
            that.set("savedQuill",true)
            that.set("loading", false)
          })
        } else {
          that.newCard(quill)
          that.$$("open-card").close()
        }
      }
      if (part == 1 && partFrom == 2){
        if (ref) {
          that.set("loading", true)
          ref.collection("big image").orderBy("time", "desc").limit(1).get().then(function(image) {
            that.set("loading", false)
            if (image && image.size) {
              that.set("addingBigImage", image.docs[0].data().value)
              that.set("cardHeading", "Change Image")
            } else {
              that.set("addingBigImage", "")
              that.set("cardHeading", "Add Image") 
            }
          }).catch(function(e) {
            console.log(e)
            that.set("loading", false)
          })
        } else {
          that.newCard()
          that.$$("open-card").close()
        }
      }
      if (part == 2) {
        this.cardHeading = "Name it" 
      }
      if (part == 2 && partFrom == 3){
        this.set("loading", true)
        if (ref) {
          ref.get().then(function(doc){
            var name = doc.data().title
            that.set("addingName", name)
            that.set("selectedItem.title", name)
            that.set("cardHeading", "Name")
            that.set("loading", false)
          }).catch(function(e) {
            console.log(e)
            that.set("loading", false)
          })
        } 
      }
      if (part == 3) {
        this.loading = false
        this.cardHeading = "" 
      }
      if (part == 3 && partFrom == 2){
        if (ref){
          that.newCard()
        }
        that.addToCard(ref)
      }
    },
    addToCard: function(cardRef) {
      if (this.addingName || this.addingImage) {
        var that = this
        cardRef.set({
          title: that.addingName,
        }).then(function() {
          that.set("selectedItem", {
            ref:   cardRef,
            title: that.addingName,
            selected: true,
          })
          cardRef.collection("big image").add({
            value: that.addingBigImage,
            time:  Date.now(), // firebase.database.ServerValue.TIMESTAMP,
            user:  firebase.auth().currentUser.uid,
          }).then(function() {
            cardRef.collection("image").add({
              value: that.addingImage,
              time:  Date.now(), // firebase.database.ServerValue.TIMESTAMP,
              user:  firebase.auth().currentUser.uid,
            }).then(function() {
              that.set("addingBigImage", "")
              that.set("addingImage", "")
            })
          })
        })
      }
    },
    render: function() {
      this.go = !this.go
      if (this.$$("#list0")) this.$$("#list0").render()
      if (this.$$("#list1")) this.$$("#list1").render()
    },
    getSelectedItem: function(items) {
      this.loading = true
      if (items && items != null && items.filter(this.selected).length) {
        this.selectedItem = items.filter(this.selected)[0]
      } else {
        if (items && items != null && this.items[0]) {
          this.items = this.items.map(function(x,i){
            if (i == 0) {
              x.selected = true
            } else {
              x.selected = false
            }
            return x
          })
        }
      }
    },
    cardTapped: function(e, d) {
      if (d.hasOwnProperty("target")) {
        if (d.target.attributes.id) {
          if (typeof this[d.target.id] === "function") {
            this[d.target.id](d)
          }
        }
      }
    },
    edit: function(e,d) {
      this.set("editing",d)
      this.$.editor.open(d)
    },
    getStartAt: function(pages, find){
      if (find) {
        return find
      } else if (pages.length) {
        return pages[pages.length - 1].start
      } else {
        return ""
      }
    },
    perv: function(){
      this.pages.pop()
      if (this.pages.length) {
        this.find = this.pages[this.pages.length - 1].start
      } else {
        this.find = ""
      }
      this.pages = this.pages.map(function(x) {return x}) // update
      return 1
    },
    next: function(){
      var start = this.nextPageStartAt
      this.find = start
      // var end = this.end
      if ((this.pages.length === 0 || start !== this.pages[this.pages.length-1].start)) { // && this.pages.length < end) {
        this.pages.push({
          start: start,
        })
        this.pages = this.pages.map(function(x) {return x}) // update 
        
        return 1
      }
      return 0
    },
    getPagesLength: function(pages){
      return pages.length
    },
    setItems: function(ref, byChild, loadNum, startAt, wide){
      var that = this
      if (!wide) {
        loadNum = 5
      }
      
      function objectToArray(data) {
        var output = []
        if (data) {
          var keys = Object.keys(data)
          for (var i = 0; i < keys.length; i++) {
            if (typeof data[keys[i]] === 'object') {
              data[keys[i]].__key = keys[i]
              output.push(data[keys[i]])
            }
          }
        }
        return output
      }
      function sortByChild (a,b){
        if (a.hasOwnProperty(byChild) && b.hasOwnProperty(byChild)) {
          var A = a[byChild].toUpperCase()
          var B = b[byChild].toUpperCase()       
          if (A < B) { return -1 }
          if (A > B) { return 1 }
        }
        return 0
      }
      var setItems = function(snap) {
        var theSnap = snap.docs
        if (theSnap && !snap.empty ) {
          that.set("loaded", theSnap.length)
          // that.items = theSnap.sort(sortByChild) 
          var cards = [];
          theSnap.forEach(function(doc) {
            cards.push({
              title: doc.data().title,
              ref: doc.ref,
            })
          })
          that.set("items", cards)
          that.render()
          if (that.loaded == +loadNum) {
            if (that.items[+loadNum - 1][byChild]) {
              that.nextPageStartAt = that.items[+loadNum - 1][byChild] + "~"
            } else {
              that.nextPageStartAt = "A"
            }
          } else {
            that.nextPageStartAt = null
            that.end = 1+that.pagesLength
          }
        } else {
          that.nextPageStartAt = null
          that.end = 1+that.pagesLength
          that.items = null
        }
      }
      var listRef
      if (byChild === "__key"){
        listRef = ref
      } else {
        listRef = ref.orderBy(byChild)
      }
      if (this.unsub) {
        this.unsub()
      }
      if (startAt) {
        this.unsub = listRef.startAt(startAt).limit(+loadNum).onSnapshot(setItems)
      } else {
        this.unsub = listRef.limit(+loadNum).onSnapshot(setItems) // TODO 
      }
    },
    open: function(e,d){
      this.fire("open-card",{e:e,d:d})
    },
    pickable: function(item){
      return !item.selected
    },
    selected: function(item){
      return item.selected || false
    },
    select: function(e){
      this.selectedItem = e.target.parentNode.parentNode.card || e.target.parentNode.card || e.target.card
      var cardTitle = this.selectedItem.title || this.selectedItem.name
      var id  = this.selectedItem.id
      
      this.items = this.items.map(function(x,i){
        if (x.title == cardTitle || x.name == cardTitle || x.id === id) {
          x.selected = true
        } else {
          x.selected = false
        }
        return x
      })
    },
    selectOpen: function(e){
      this.select(e)
      this.cardPart = 1
      this.$$("open-card").open()
    },
  })
</script>
