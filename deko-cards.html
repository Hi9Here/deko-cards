<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../deko-card-container/deko-card-container.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../content-card/content-card.html">
<link rel="import" href="../content-card/content-view.html">
<link rel="import" href="../content-card/content-edit.html">
<link rel="import" href="../deko-opened-card/deko-opened-card.html">
<link rel="import" href="../deko-deck-editor/deko-deck-editor.html">
<link rel="import" href="../deko-pillar/deko-pillar.html">
<link rel="import" href="../input-image/input-image.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../deko-card/deko-card.html">
<!--
  `deko-cards`
  @demo
-->
<dom-module id="deko-cards">
  <template>
    <style>
      #narrow {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        height: 100%;
      }
      paper-button {
        color: #fff;
        padding: 5px;
      }
      #card-view {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        @apply(--layout-wrap);
      }
      deko-card-container {
        margin-top: 50px;
      }
      .pre.desktop {
        left: 80px;
      }
      .nex.desktop {
        right: 80px;
      }
      .desktop {
        position: absolute;
        top: 320px;
      }
      .nex.mobile {
        position: absolute;
        left: 200px;
        bottom: -45px;
      }
      .pre.mobile {
        position: absolute;
        left: 200px;
        bottom: -25px;
      }
      .mobile {
        transform: rotate(90deg);   
      }
      paper-button {
        min-width: 2em;
        min-height: 8em;
        background: none;
        color: #ff5722;
      }
      h6 {
        -webkit-transform:scale(3,15); /* Safari and Chrome */
        -moz-transform:scale(3,15); /* Firefox */
        -ms-transform:scale(3,15); /* IE 9 */
        -o-transform:scale(3,15); /* Opera */
        transform:scale(3,15); /* W3C */
      }
      paper-toolbar {
        --paper-toolbar-height: 35px;
        --paper-toolbar-sm-height: 35px;
        --paper-toolbar-title: {
          font-size: 18px;
          font-weight: 300;
        }
      }
      .toolbarMobile {
         box-shadow: 0 -2px 0px 0 rgba(0, 0, 0, 0.14),
                     0 -1px 0px 0 rgba(0, 0, 0, 0.12),
                     0 -3px 1px -2px rgba(0, 0, 0, 0.2);
         margin-left: 2px;
      }
    </style>
    <app-route route="{{route}}" pattern="/:data" data="{{routeData}}" tail="{{tail}}"></app-route>
    <iron-media-query query="(min-width: 700px)" query-matches="{{wide}}"></iron-media-query>
    
      <!--Wide Layout for Desktop-->
      <template is="dom-if" if="{{wide}}">
        <template is="dom-if" if="[[pageing]]" restamp>
          <paper-input label="Start At ..." value="{{find}}"></paper-input>
        </template>
        <div id="card-view">
          <div class="pre desktop">
            <template is="dom-if" if="[[pagesLength]]">
              <paper-button on-tap="perv"><h6>&lt;</h6></paper-button>
            </template>
          </div>
          <deko-card-container>
            <template is="dom-repeat" items="{{items}}" initial-Count="1" id="list0">
              <deko-card deck="[[deck]]" toolbar-color="[[deckColor]]" card="[[item]]" icon="[[item.icon]]" on-tapped="cardTapped" on-edit="edit" on-open="open"></deko-card>
            </template>
          </deko-card-container>
          <div class="nex desktop">
            <template is="dom-if" if="[[nextPageStartAt]]">
              <paper-button on-tap="next"><h6>></h6> </paper-button>
            </template>
          </div>
        </div>
        <template is="dom-if" if="[[!noAdd]]">
          <paper-fab style="position: fixed;right: 25px;bottom: 30px" icon="add" on-tap="addCard"></paper-fab>
        </template>
      </template>
      <!--Narrow Layout under 700px-->
      <template is="dom-if" if="{{!wide}}">
        <template is="dom-if" if="[[pageing]]" restamp>
          <paper-input label="Start At ..." value="{{find}}"></paper-input>
        </template>
        <div style="height: 100%">
          <div class="pre mobile">
            <template is="dom-if" if="[[pagesLength]]">
              <paper-button on-tap="perv"><h6>&lt;</h6></paper-button>
            </template>
          </div>
          <template is="dom-repeat" items="{{items}}" filter="pickable"  id="list1">
            <paper-toolbar class="toolbarMobile" on-tap="select" card="[[item]]" style$="background:[[deckColor]]; height: 35px;">
              <iron-icon icon="[[item.icon]]" style="height:90%"></iron-icon>
              <div class="title" >[[item.title]]</div>
            </paper-toolbar>
          </template>
          <div id="narrow">
            <deko-card deck="[[deck]]" style="height:100%;width:100%" toolbar-color="[[deckColor]]" card="[[selectedItem]]" icon="[[selectedItem.icon]]" on-tapped="cardTapped" on-edit="edit" on-open="open"></deko-card>
          </div>
          <div class="nex mobile">
            <template is="dom-if" if="[[nextPageStartAt]]">
              <paper-button on-tap="next"><h6>></h6> </paper-button>
            </template>
          </div>
        </div>
      </template>
      <template is="dom-if" if="[[!noAdd]]">
        <paper-fab style="position: fixed;right: 25px;bottom: 30px" icon="add" on-tap="addCard"></paper-fab>
      </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "deko-cards",
    properties:{
      _setItems:{
        computed:"setItems(path, byChild, loadNum, startAt, wide)",
      },
      end:{value: 999},
      path:{type: String},
      find:{value: ""},
      deck:{value: ""},
      pages:{value: []},
      noAdd:{
        type:Boolean,
        value:false,
      },
      byChild:{type: String, value:'title'},
      loadNum:{type: Number, value: 10},
      startAt:{computed:"getStartAt(pages, find)"},
      pagesLength:{computed:"getPagesLength(pages)"},
      useTemplates: Object,
      pageing:{
        type:Boolean,
        value:false,
      },
      _setSelectedItem:{
        computed:"getSelectedItem(items)"
      },
      _routeData: {
        computed: "_log('routeData.data',routeData.data)"
      },
      _profile: {
        computed: "_log('ref',ref)"
      },
    },
    _log: function(a,b) {
      b.collection("cards").doc("First Card!").set({
        foo: "bar"
      })
      console.log(a,b)
    },
    addCard: function() {
      this.fire("add-card")
    },
    render: function() {
      this.go = !this.go
      if (this.$$("#list0")) this.$$("#list0").render()
      if (this.$$("#list1")) this.$$("#list1").render()
    },
    getSelectedItem: function(items) {
      if (items && items != null && items.filter(this.selected).length) {
        this.selectedItem = items.filter(this.selected)[0] 
      } else {
        if (items && items != null && this.items[0]) {
          this.items = this.items.map(function(x,i){
            if (i == 0) {
              x.selected = true
            } else {
              x.selected = false
            }
            return x
          })
        }
      }
    },
    cardTapped: function(e, d) {
      if (d.hasOwnProperty("target")) {
        if (d.target.attributes.id) {
          if (typeof this[d.target.id] === "function") {
            this[d.target.id](d)
          }
        }
      }
    },
    edit: function(e,d) {
      this.set("editing",d)
      this.$.editor.open(d)
    },
    getStartAt: function(pages, find){
      if (find) {
        return find
      } else if (pages.length) {
        return pages[pages.length - 1].start
      } else {
        return ""
      }
    },
    perv: function(){
      this.pages.pop()
      if (this.pages.length) {
        this.find = this.pages[this.pages.length - 1].start
      } else {
        this.find = ""
      }
      this.pages = this.pages.map(function(x) {return x}) // update
      return 1
    },
    next: function(){
      var start = this.nextPageStartAt
      this.find = start
      // var end = this.end
      if ((this.pages.length === 0 || start !== this.pages[this.pages.length-1].start)) { // && this.pages.length < end) {
        this.pages.push({
          start: start,
        })
        this.pages = this.pages.map(function(x) {return x}) // update 
        
        return 1
      }
      return 0
    },
    getPagesLength: function(pages){
      return pages.length
    },
    setItems: function(path, byChild, loadNum, startAt, wide){
      var that = this
      if (!wide) {
        loadNum = 5
      }
      
      function objectToArray(data) {
        var output = []
        if (data) {
          var keys = Object.keys(data)
          for (var i = 0; i < keys.length; i++) {
            if (typeof data[keys[i]] === 'object') {
              data[keys[i]].__key = keys[i]
              output.push(data[keys[i]])
            }
          }
        }
        return output
      }
      function sortByChild (a,b){
        if (a.hasOwnProperty(byChild) && b.hasOwnProperty(byChild)) {
          var A = a[byChild].toUpperCase()
          var B = b[byChild].toUpperCase()       
          if (A < B) { return -1 }
          if (A > B) { return 1 }
        }
        return 0
      }
      var setItems = function(snap) {
        var theSnap = snap.val()
        if (theSnap) {
          that.loaded = Object.keys(theSnap).length
          that.items = objectToArray(theSnap).sort(sortByChild)
          that.render()
          if (that.loaded == +loadNum) {
            if (that.items[+loadNum - 1][byChild]) {
              that.nextPageStartAt = that.items[+loadNum - 1][byChild] + "~"
            } else {
              that.nextPageStartAt = "A"
            }
          } else {
            that.nextPageStartAt = null
            that.end = 1+that.pagesLength
          }
        } else {
          that.nextPageStartAt = null
          that.end = 1+that.pagesLength
          that.items = null
        }
      }
      var listRef
      if (byChild === "__key"){
        listRef = firebase.database().ref(path).orderByKey()
      } else {
        listRef = firebase.database().ref(path).orderByChild(byChild)
      }
      if (startAt) {
        listRef.startAt(startAt).limitToFirst(+loadNum).on("value", setItems)
      } else {
        listRef.limitToFirst(+loadNum).on("value", setItems)
      }
    },
    open: function(e,d){
      this.fire("open-card",{e:e,d:d})
    },
    pickable: function(item){
      return !item.selected
    },
    selected: function(item){
      return item.selected || false
    },
    select: function(e){
      this.selectedItem = e.target.parentNode.parentNode.card || e.target.parentNode.card || e.target.card
      var cardTitle = this.selectedItem.title || this.selectedItem.name
      this.items = this.items.map(function(x,i){
        if (x.title == cardTitle || x.name == cardTitle) {
          x.selected = true
        } else {
          x.selected = false
        }
        return x
      })
    }
  })
</script>
